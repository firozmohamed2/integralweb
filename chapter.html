<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter Selection</title>
    <!-- Firebase SDKs (compat version to match index.html) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f4f7f6;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
      }
      .add-btn-main {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        background: #28a745;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border: none;
      }
      .add-btn-main:hover {
        background: #218838;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      .chapter-input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }
      #chapterInputsList {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 5px;
        border: 1px inset #eee;
      }
      .selection-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
      }
      .btn {
        padding: 12px 24px;
        font-size: 18px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        transition:
          background-color 0.3s,
          transform 0.2s;
      }
      .btn:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
      }
      .btn:active {
        transform: translateY(0);
      }
      .list-container {
        margin-top: 20px;
      }
      .list-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 4px;
      }
      .list-item:hover {
        background-color: #f0f8ff;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .chapter-item {
        padding: 10px;
        margin-left: 20px;
        border-left: 3px solid #007bff;
        background: #fff;
        margin-bottom: 5px;
        border-radius: 0 4px 4px 0;
      }
      .back-btn {
        margin-bottom: 20px;
        display: none;
        cursor: pointer;
        color: #007bff;
        font-weight: bold;
      }
      h2,
      h3 {
        color: #2c3e50;
      }
      #loading {
        text-align: center;
        display: none;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Integral Web Chapters</h1>
        <div
          id="currentUser"
          style="margin-top: 10px; font-size: 14px; color: #555"
        ></div>
      </div>

      <div id="classSelection" class="selection-buttons">
        <button
          class="btn"
          onclick="fetchChapters('chapterList_class11', 'Class 11')"
        >
          Class 11
        </button>
        <button
          class="btn"
          onclick="fetchChapters('chapterList_class12', 'Class 12')"
        >
          Class 12
        </button>
      </div>

      <div id="backButton" class="back-btn" onclick="showClassSelection()">
        ← Back to Class Selection
      </div>
      <div id="docBackButton" class="back-btn" onclick="showDocList()">
        ← Back to Subjects
      </div>
      <div id="topicBackButton" class="back-btn" onclick="showChapterList()">
        ← Back to Chapters
      </div>
      <div id="subtopicBackButton" class="back-btn" onclick="showTopicList()">
        ← Back to Topics
      </div>

      <h2 id="viewTitle">Select a Class</h2>
      <div style="position: relative">
        <button
          id="addSubjectBtn"
          class="add-btn-main"
          onclick="openAddSubjectModal()"
        >
          +
        </button>
        <button
          id="addChapterBtn"
          class="add-btn-main"
          onclick="openAddChapterModal()"
        >
          +
        </button>
        <button
          id="addTopicBtn"
          class="add-btn-main"
          onclick="openAddTopicModal()"
        >
          +
        </button>
        <button
          id="addSubtopicBtn"
          class="add-btn-main"
          onclick="openSubtopicJsonEditor(null, 'New Subtopic')"
        >
          +
        </button>
      </div>

      <div id="loading">Loading...</div>
      <div id="contentList" class="list-container"></div>
    </div>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="modal">
      <div class="modal-content">
        <h3>Add New Subject</h3>
        <div class="form-group">
          <label>Subject Name</label>
          <input type="text" id="newSubjectName" placeholder="e.g. Physics" />
        </div>
        <div class="form-group">
          <label>Chapters</label>
          <div id="chapterInputsList">
            <div class="chapter-input-row">
              <input
                type="text"
                class="chapter-input"
                placeholder="Chapter Name"
              />
            </div>
          </div>
          <button
            class="btn"
            style="
              padding: 5px 10px;
              font-size: 14px;
              background-color: #6c757d;
            "
            onclick="addChapterInput()"
          >
            + Add Another Chapter
          </button>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background-color: #6c757d"
            onclick="closeAddSubjectModal()"
          >
            Cancel
          </button>
          <button class="btn" onclick="saveSubject()">Save Subject</button>
        </div>
      </div>
    </div>

    <!-- Add Chapter Modal -->
    <div id="addChapterModal" class="modal">
      <div class="modal-content">
        <h3>Add New Chapter</h3>
        <div class="form-group">
          <label>Chapter Name</label>
          <input
            type="text"
            id="newChapterName"
            placeholder="e.g. Differentiation"
          />
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background-color: #6c757d"
            onclick="closeAddChapterModal()"
          >
            Cancel
          </button>
          <button class="btn" onclick="saveChapter()">Save Chapter</button>
        </div>
      </div>
    </div>

    <!-- Add Topic Modal -->
    <div id="addTopicModal" class="modal">
      <div class="modal-content">
        <h3>Add New Topic</h3>
        <div class="form-group">
          <label>Topic Name</label>
          <input type="text" id="newTopicName" placeholder="e.g. Chain Rule" />
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background-color: #6c757d"
            onclick="closeAddTopicModal()"
          >
            Cancel
          </button>
          <button class="btn" onclick="saveTopic()">Save Topic</button>
        </div>
      </div>
    </div>

    <!-- Add Subtopic Modal -->
    <div id="addSubtopicModal" class="modal">
      <div class="modal-content">
        <h3>Add New Subtopic</h3>
        <div class="form-group">
          <label>Subtopic Name</label>
          <input
            type="text"
            id="newSubtopicName"
            placeholder="e.g. Product Rule"
          />
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background-color: #6c757d"
            onclick="closeAddSubtopicModal()"
          >
            Cancel
          </button>
          <button class="btn" onclick="saveSubtopic()">Save Subtopic</button>
        </div>
      </div>
    </div>

    <!-- Subtopic JSON Editor Modal -->
    <div id="subtopicJsonModal" class="modal">
      <div class="modal-content">
        <h3 id="subtopicJsonTitle">Edit Subtopic JSON</h3>
        <div class="form-group">
          <label>Current Data (Editable)</label>
          <div
            id="subtopicFieldsContainer"
            style="
              max-height: 300px;
              overflow-y: auto;
              border: 1px solid #ddd;
              padding: 10px;
              background: #f9f9f9;
            "
          >
            <!-- Dynamic fields will appear here -->
          </div>
        </div>
        <div class="form-group">
          <label
            >New Addition (will be merged) -
            <span style="font-size: 11px; font-weight: normal; color: #666"
              >You can paste images here</span
            ></label
          >
          <div style="margin-bottom: 10px">
            <button
              class="btn"
              style="padding: 5px 10px; font-size: 12px; margin-right: 5px"
              onclick="setImageType('questionimage')"
            >
              Question Image
            </button>
            <button
              class="btn"
              style="padding: 5px 10px; font-size: 12px; margin-right: 5px"
              onclick="setImageType('answerimage')"
            >
              Answer Image
            </button>
            <button
              class="btn"
              style="padding: 5px 10px; font-size: 12px; margin-right: 5px"
              onclick="setImageType('answerimage2')"
            >
              Answer Image 2
            </button>
            <button
              class="btn"
              style="padding: 5px 10px; font-size: 12px; margin-right: 5px"
              onclick="setImageType('answerimage3')"
            >
              Answer Image 3
            </button>
            <button
              class="btn"
              style="padding: 5px 10px; font-size: 12px"
              onclick="addQuestionText()"
            >
              Question Text
            </button>
            <div
              id="currentImageType"
              style="font-size: 11px; color: #007bff; margin-top: 5px"
            >
              Selected: <strong>questionimage</strong>
            </div>
          </div>
          <textarea
            id="subtopicNewJsonTextarea"
            style="width: 100%; height: 180px; font-family: monospace"
            placeholder="Paste JSON here or paste an image to upload..."
          ></textarea>
          <div
            id="imageUploadStatus"
            style="
              font-size: 12px;
              color: #007bff;
              margin-top: 5px;
              display: none;
            "
          >
            Uploading image...
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background-color: #6c757d"
            onclick="closeSubtopicJsonModal()"
          >
            Cancel
          </button>
          <button class="btn" onclick="saveSubtopicJson()">Save JSON</button>
        </div>
      </div>
    </div>

    <script>
      // Firebase Config (Copied from index.html)
      const firebaseConfig = {
        apiKey: "AIzaSyDNqfRczOHTukGdXDnuzVXjbL7P5blnyAo",
        authDomain: "dbydx-ea226.firebaseapp.com",
        projectId: "dbydx-ea226",
        storageBucket: "dbydx-ea226.firebasestorage.app",
        messagingSenderId: "329650707379",
        appId: "1:329650707379:web:18bab2bab403e1004b89c6",
        measurementId: "G-2F7YVE2X94",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();
      const auth = firebase.auth();

      // Listen for auth state changes
      auth.onAuthStateChanged((user) => {
        const userDiv = document.getElementById("currentUser");
        if (user) {
          console.log("User is logged in:", user.uid);
          userDiv.textContent = `Logged in as: ${user.email || "Anonymous User"}`;
        } else {
          console.log("No user logged in, signing in anonymously...");
          userDiv.textContent = "";
          auth.signInAnonymously().catch((error) => {
            console.error("Anonymous sign-in failed:", error);
          });
        }
      });

      let currentCollection = "";
      let currentClassName = "";
      let currentDocs = [];
      let currentDocId = ""; // Subject ID
      let currentDocData = null;
      let currentChapterId = "";
      let currentChapterNameString = "";
      let currentTopicId = "";
      let currentTopicNameString = "";
      let currentSubtopicDocId = "";
      let currentSubtopicLabel = "";
      let currentImageType = "questionimage";

      function setImageType(type) {
        currentImageType = type;
        document.getElementById("currentImageType").innerHTML =
          `Selected: <strong>${type}</strong>`;
      }

      async function fetchChapters(collectionName, className) {
        currentCollection = collectionName;
        currentClassName = className;

        const contentList = document.getElementById("contentList");
        const viewTitle = document.getElementById("viewTitle");
        const loading = document.getElementById("loading");
        const classSelection = document.getElementById("classSelection");
        const backButton = document.getElementById("backButton");
        const addSubjectBtn = document.getElementById("addSubjectBtn");
        const addChapterBtn = document.getElementById("addChapterBtn");
        const addTopicBtn = document.getElementById("addTopicBtn");
        const addSubtopicBtn = document.getElementById("addSubtopicBtn");

        // UI Updates
        classSelection.style.display = "none";
        backButton.style.display = "block";
        addSubjectBtn.style.display = "flex";
        addChapterBtn.style.display = "none";
        addTopicBtn.style.display = "none";
        addSubtopicBtn.style.display = "none";
        viewTitle.innerText = `Subjects (${className})`;
        contentList.innerHTML = "";
        loading.style.display = "block";

        try {
          const querySnapshot = await db.collection(collectionName).get();
          loading.style.display = "none";

          if (querySnapshot.empty) {
            contentList.innerHTML =
              "<p>No documents found in this collection.</p>";
            return;
          }

          currentDocs = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            currentDocs.push({ id: doc.id, ...data });

            const div = document.createElement("div");
            div.className = "list-item";
            // Use a display name if available, otherwise use doc ID
            div.innerText = data.name || data.title || doc.id;
            div.onclick = () => showDocumentDetails(doc.id, data);
            contentList.appendChild(div);
          });
        } catch (error) {
          console.error("Error fetching documents: ", error);
          loading.style.display = "none";
          contentList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      async function showDocumentDetails(docId, data) {
        currentDocId = docId;
        currentDocData = data;
        const contentList = document.getElementById("contentList");
        const viewTitle = document.getElementById("viewTitle");
        const backButton = document.getElementById("backButton");
        const docBackButton = document.getElementById("docBackButton");
        const topicBackButton = document.getElementById("topicBackButton");
        const addSubjectBtn = document.getElementById("addSubjectBtn");
        const addChapterBtn = document.getElementById("addChapterBtn");
        const addTopicBtn = document.getElementById("addTopicBtn");
        const addSubtopicBtn = document.getElementById("addSubtopicBtn");
        const loading = document.getElementById("loading");

        backButton.style.display = "none";
        docBackButton.style.display = "block";
        topicBackButton.style.display = "none";
        addSubjectBtn.style.display = "none";
        addChapterBtn.style.display = "flex";
        addTopicBtn.style.display = "none";
        addSubtopicBtn.style.display = "none";
        const subjectName = data.name || data.title || docId;
        viewTitle.innerText = `Chapters - ${subjectName}`;
        contentList.innerHTML = "";
        loading.style.display = "block";

        try {
          const querySnapshot = await db
            .collection(currentCollection)
            .doc(docId)
            .collection("chapters")
            .get();
          loading.style.display = "none";

          if (querySnapshot.empty) {
            contentList.innerHTML =
              "<p>No chapters found for this subject.</p>";
            return;
          }

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const chapterName = data.name || doc.id;
            const div = document.createElement("div");
            div.className = "chapter-item list-item";
            div.innerText = chapterName;
            div.onclick = () => fetchTopics(doc.id, chapterName);
            contentList.appendChild(div);
          });
        } catch (error) {
          console.error("Error fetching chapters: ", error);
          loading.style.display = "none";
          contentList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      async function fetchTopics(chapterId, chapterNameString) {
        currentChapterId = chapterId;
        currentChapterNameString = chapterNameString;
        const contentList = document.getElementById("contentList");
        const viewTitle = document.getElementById("viewTitle");
        const docBackButton = document.getElementById("docBackButton");
        const topicBackButton = document.getElementById("topicBackButton");
        const loading = document.getElementById("loading");
        const addChapterBtn = document.getElementById("addChapterBtn");
        const addTopicBtn = document.getElementById("addTopicBtn");
        const addSubtopicBtn = document.getElementById("addSubtopicBtn");

        docBackButton.style.display = "none";
        topicBackButton.style.display = "block";
        addChapterBtn.style.display = "none";
        addTopicBtn.style.display = "flex";
        addSubtopicBtn.style.display = "none";
        viewTitle.innerText = `Topics - ${chapterNameString}`;
        contentList.innerHTML = "";
        loading.style.display = "block";

        try {
          const querySnapshot = await db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .doc(chapterId)
            .collection("topics")
            .get();
          loading.style.display = "none";

          if (querySnapshot.empty) {
            contentList.innerHTML = `<p>No topics found for chapter: ${chapterNameString}</p>`;
            return;
          }

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const topicName = data.name || doc.id;
            const div = document.createElement("div");
            div.className = "chapter-item list-item";
            div.innerText = topicName;
            div.onclick = () => fetchSubtopics(doc.id, topicName);
            contentList.appendChild(div);
          });
        } catch (error) {
          console.error("Error fetching topics: ", error);
          loading.style.display = "none";
          contentList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      async function fetchSubtopics(topicId, topicNameString) {
        currentTopicId = topicId;
        currentTopicNameString = topicNameString;

        const contentList = document.getElementById("contentList");
        const viewTitle = document.getElementById("viewTitle");
        const topicBackButton = document.getElementById("topicBackButton");
        const subtopicBackButton =
          document.getElementById("subtopicBackButton");
        const loading = document.getElementById("loading");
        const addTopicBtn = document.getElementById("addTopicBtn");
        const addSubtopicBtn = document.getElementById("addSubtopicBtn");

        topicBackButton.style.display = "none";
        subtopicBackButton.style.display = "block";
        addTopicBtn.style.display = "none";
        addSubtopicBtn.style.display = "flex";
        viewTitle.innerText = `Subtopics - ${topicNameString}`;
        contentList.innerHTML = "";
        loading.style.display = "block";

        try {
          const querySnapshot = await db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .doc(currentChapterId)
            .collection("topics")
            .doc(topicId)
            .collection("subtopiclist")
            .get();
          loading.style.display = "none";

          if (querySnapshot.empty) {
            contentList.innerHTML = `<p>No subtopics found for: ${topicNameString}</p>`;
            return;
          }

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const subtopicLabel = data.name || doc.id;
            const div = document.createElement("div");
            div.className = "chapter-item";
            
            if (data.questionimage) {
                // If questionimage exists, show it (larger size)
                div.innerHTML = `<img src="${data.questionimage}" alt="Question" style="max-width: 100%; max-height: 300px; display: block; margin: 0 auto;">`;
            } else {
                // Otherwise show the label/name/id
                div.innerText = subtopicLabel;
            }
            
            div.onclick = () => openSubtopicJsonEditor(doc.id, subtopicLabel);
            contentList.appendChild(div);
          });
        } catch (error) {
          console.error("Error fetching subtopics: ", error);
          loading.style.display = "none";
          contentList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
      }

      function showClassSelection() {
        document.getElementById("classSelection").style.display = "flex";
        document.getElementById("backButton").style.display = "none";
        document.getElementById("docBackButton").style.display = "none";
        document.getElementById("topicBackButton").style.display = "none";
        document.getElementById("subtopicBackButton").style.display = "none";
        document.getElementById("addSubjectBtn").style.display = "none";
        document.getElementById("addChapterBtn").style.display = "none";
        document.getElementById("addTopicBtn").style.display = "none";
        document.getElementById("addSubtopicBtn").style.display = "none";
        document.getElementById("viewTitle").innerText = "Select a Class";
        document.getElementById("contentList").innerHTML = "";
      }

      function showDocList() {
        document.getElementById("docBackButton").style.display = "none";
        document.getElementById("topicBackButton").style.display = "none";
        document.getElementById("subtopicBackButton").style.display = "none";
        document.getElementById("addSubjectBtn").style.display = "flex";
        document.getElementById("addChapterBtn").style.display = "none";
        document.getElementById("addTopicBtn").style.display = "none";
        document.getElementById("addSubtopicBtn").style.display = "none";
        fetchChapters(currentCollection, currentClassName);
      }

      function showChapterList() {
        document.getElementById("topicBackButton").style.display = "none";
        document.getElementById("subtopicBackButton").style.display = "none";
        document.getElementById("addSubjectBtn").style.display = "none";
        document.getElementById("addChapterBtn").style.display = "flex";
        document.getElementById("addTopicBtn").style.display = "none";
        document.getElementById("addSubtopicBtn").style.display = "none";
        showDocumentDetails(currentDocId, currentDocData);
      }

      function showTopicList() {
        document.getElementById("subtopicBackButton").style.display = "none";
        document.getElementById("addTopicBtn").style.display = "flex";
        document.getElementById("addSubtopicBtn").style.display = "none";
        fetchTopics(currentChapterId, currentChapterNameString);
      }

      // Modal Logic
      function openAddSubjectModal() {
        document.getElementById("addSubjectModal").style.display = "block";
        document.getElementById("newSubjectName").value = "";
        document.getElementById("chapterInputsList").innerHTML = `
            <div class="chapter-input-row">
                <input type="text" class="chapter-input" placeholder="Chapter Name">
            </div>
        `;
      }

      function closeAddSubjectModal() {
        document.getElementById("addSubjectModal").style.display = "none";
      }

      function addChapterInput() {
        const list = document.getElementById("chapterInputsList");
        const div = document.createElement("div");
        div.className = "chapter-input-row";
        div.innerHTML =
          '<input type="text" class="chapter-input" placeholder="Chapter Name">';
        list.appendChild(div);
      }

      async function saveSubject() {
        const subjectName = document
          .getElementById("newSubjectName")
          .value.trim();
        if (!subjectName) {
          alert("Please enter a subject name");
          return;
        }

        const chapterInputs = document.querySelectorAll(".chapter-input");
        const chapters = [];
        chapterInputs.forEach((input) => {
          const val = input.value.trim();
          if (val) chapters.push(val);
        });

        const loading = document.getElementById("loading");
        loading.style.display = "block";
        closeAddSubjectModal();

        try {
          // Using subject name as document ID
          const subjectRef = db.collection(currentCollection).doc(subjectName);
          await subjectRef.set({
            name: subjectName,
          });

          // Add chapters as subcollection documents
          for (const chName of chapters) {
            await subjectRef.collection("chapters").add({
              name: chName,
            });
          }

          alert("Subject and chapters added successfully!");
          fetchChapters(currentCollection, currentClassName); // Refresh list
        } catch (error) {
          console.error("Error saving subject: ", error);
          alert("Error saving subject: " + error.message);
          loading.style.display = "none";
        }
      }

      // Chapter Modal Logic
      function openAddChapterModal() {
        document.getElementById("addChapterModal").style.display = "block";
        document.getElementById("newChapterName").value = "";
      }

      function closeAddChapterModal() {
        document.getElementById("addChapterModal").style.display = "none";
      }

      async function saveChapter() {
        const chapterName = document
          .getElementById("newChapterName")
          .value.trim();
        if (!chapterName) {
          alert("Please enter a chapter name");
          return;
        }

        const loading = document.getElementById("loading");
        loading.style.display = "block";
        closeAddChapterModal();

        try {
          await db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .add({
              name: chapterName,
            });

          alert("Chapter added successfully!");

          // Refresh chapters list
          showDocumentDetails(currentDocId, currentDocData);
        } catch (error) {
          console.error("Error saving chapter: ", error);
          alert("Error saving chapter: " + error.message);
          loading.style.display = "none";
        }
      }

      // Topic Modal Logic
      function openAddTopicModal() {
        document.getElementById("addTopicModal").style.display = "block";
        document.getElementById("newTopicName").value = "";
      }

      function closeAddTopicModal() {
        document.getElementById("addTopicModal").style.display = "none";
      }

      async function saveTopic() {
        const topicName = document.getElementById("newTopicName").value.trim();
        if (!topicName) {
          alert("Please enter a topic name");
          return;
        }

        const loading = document.getElementById("loading");
        loading.style.display = "block";
        closeAddTopicModal();

        try {
          await db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .doc(currentChapterId)
            .collection("topics")
            .add({
              name: topicName,
            });

          alert("Topic added successfully!");
          fetchTopics(currentChapterId, currentChapterNameString); // Refresh the topics list
        } catch (error) {
          console.error("Error saving topic: ", error);
          alert("Error saving topic: " + error.message);
          loading.style.display = "none";
        }
      }

      // Subtopic Modal Logic
      function openAddSubtopicModal() {
        document.getElementById("addSubtopicModal").style.display = "block";
        document.getElementById("newSubtopicName").value = "";
      }

      function closeAddSubtopicModal() {
        document.getElementById("addSubtopicModal").style.display = "none";
      }

      async function saveSubtopic() {
        const subtopicName = document
          .getElementById("newSubtopicName")
          .value.trim();
        if (!subtopicName) {
          alert("Please enter a subtopic name");
          return;
        }

        const loading = document.getElementById("loading");
        loading.style.display = "block";
        closeAddSubtopicModal();

        try {
          await db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .doc(currentChapterId)
            .collection("topics")
            .doc(currentTopicId)
            .collection("subtopiclist")
            .add({
              name: subtopicName,
            });

          alert("Subtopic added successfully!");
          fetchSubtopics(currentTopicId, currentTopicNameString); // Refresh the subtopics list
        } catch (error) {
          console.error("Error saving subtopic: ", error);
          alert("Error saving subtopic: " + error.message);
          loading.style.display = "none";
        }
      }

      function openSubtopicJsonEditor(subtopicId, subtopicLabel) {
        currentSubtopicDocId = subtopicId;
        currentSubtopicLabel = subtopicLabel;

        const modal = document.getElementById("subtopicJsonModal");
        const fieldsContainer = document.getElementById(
          "subtopicFieldsContainer",
        );
        const newTextarea = document.getElementById("subtopicNewJsonTextarea");
        const title = document.getElementById("subtopicJsonTitle");
        const loading = document.getElementById("loading");

        title.innerText = subtopicId
          ? `Edit JSON - ${subtopicLabel}`
          : "Add New Subtopic JSON";
        modal.style.display = "block";
        fieldsContainer.innerHTML = ""; // Clear previous fields
        newTextarea.value = "";

        if (!subtopicId) {
          fieldsContainer.innerHTML =
            "<p>New subtopic - add fields below or paste JSON.</p>";
          return;
        }

        loading.style.display = "block";
        (async () => {
          try {
            const docRef = db
              .collection(currentCollection)
              .doc(currentDocId)
              .collection("chapters")
              .doc(currentChapterId)
              .collection("topics")
              .doc(currentTopicId)
              .collection("subtopiclist")
              .doc(subtopicId);

            const doc = await docRef.get();
            if (doc.exists) {
              const data = doc.data();
              if (data) {
                // Generate input fields for each key
                Object.keys(data).forEach((key) => {
                  const row = document.createElement("div");
                  row.style.marginBottom = "10px";

                  const label = document.createElement("label");
                  label.innerText = key;
                  label.style.fontSize = "12px";
                  label.style.fontWeight = "bold";
                  label.style.display = "block";

                  const input = document.createElement("input");
                  input.type = "text";
                  input.value = data[key];
                  input.dataset.key = key; // Store key for saving later
                  input.className = "dynamic-field";
                  input.style.width = "100%";
                  input.style.padding = "8px";
                  input.style.border = "1px solid #ccc";
                  input.style.borderRadius = "4px";

                  row.appendChild(label);
                  row.appendChild(input);
                  fieldsContainer.appendChild(row);
                });
              }
            }
          } catch (error) {
            console.error("Error loading subtopic JSON: ", error);
            alert("Error loading JSON: " + error.message);
          } finally {
            loading.style.display = "none";
          }
        })();
      }

      function closeSubtopicJsonModal() {
        document.getElementById("subtopicJsonModal").style.display = "none";
      }

      async function saveSubtopicJson() {
        // Gather data from dynamic fields
        const dynamicFields = document.querySelectorAll(".dynamic-field");
        let jsonData = {};

        dynamicFields.forEach((input) => {
          const key = input.dataset.key;
          const value = input.value;
          jsonData[key] = value;
        });

        // Gather data from new JSON textarea
        const newTextarea = document.getElementById("subtopicNewJsonTextarea");
        const text = newTextarea.value.trim();

        if (text) {
          try {
            const newData = JSON.parse(text);
            // Merge new data (overwriting existing keys if present)
            jsonData = { ...jsonData, ...newData };
          } catch (e) {
            alert("Invalid JSON in 'New Addition' box: " + e.message);
            return;
          }
        }

        if (Object.keys(jsonData).length === 0) {
          alert("No data to save.");
          return;
        }

        const loading = document.getElementById("loading");
        loading.style.display = "block";

        try {
          const subcollectionRef = db
            .collection(currentCollection)
            .doc(currentDocId)
            .collection("chapters")
            .doc(currentChapterId)
            .collection("topics")
            .doc(currentTopicId)
            .collection("subtopiclist");

          if (currentSubtopicDocId) {
            await subcollectionRef
              .doc(currentSubtopicDocId)
              .set(jsonData, { merge: true }); // Using merge: true just in case, but we are effectively rewriting known fields
          } else {
            await subcollectionRef.add(jsonData);
          }

          alert("JSON saved successfully!");
          closeSubtopicJsonModal();
          fetchSubtopics(currentTopicId, currentTopicNameString);
        } catch (error) {
          console.error("Error saving JSON: ", error);
          alert("Error saving JSON: " + error.message);
        } finally {
          loading.style.display = "none";
        }
      }

      function addQuestionText() {
        const textarea = document.getElementById("subtopicNewJsonTextarea");
        const text = prompt("Enter Question Text:");
        if (text === null) return;

        let currentJson = {};
        const existingText = textarea.value.trim();
        if (existingText) {
          try {
            currentJson = JSON.parse(existingText);
          } catch (e) {
            console.warn(
              "Existing text is not valid JSON, creating new object.",
            );
          }
        }

        currentJson.questiontext = text;
        textarea.value = JSON.stringify(currentJson, null, 2);
      }

      // Add paste event listener for image upload
      document
        .getElementById("subtopicNewJsonTextarea")
        .addEventListener("paste", async (event) => {
          const items = (
            event.clipboardData || event.originalEvent.clipboardData
          ).items;
          for (const item of items) {
            if (item.type.indexOf("image") !== -1) {
              const file = item.getAsFile();
              if (file) {
                uploadImage(file);
              }
            }
          }
        });

      async function uploadImage(file) {
        const status = document.getElementById("imageUploadStatus");
        const textarea = document.getElementById("subtopicNewJsonTextarea");

        status.style.display = "block";
        status.innerText = `Uploading ${currentImageType}...`;

        try {
          const fileName = `${currentImageType}_${Date.now()}_${file.name}`;
          const storageRef = storage.ref(
            `subtopic_images/${currentDocId}/${currentChapterId}/${currentTopicId}/${currentSubtopicDocId}/${fileName}`,
          );

          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();

          status.innerText = `${currentImageType} uploaded successfully!`;

          // Update the JSON in the textarea
          let currentJson = {};
          const text = textarea.value.trim();
          if (text) {
            try {
              currentJson = JSON.parse(text);
            } catch (e) {
              console.warn(
                "Existing text is not valid JSON, appending image field.",
              );
            }
          }

          currentJson[currentImageType] = downloadURL;
          textarea.value = JSON.stringify(currentJson, null, 2);
        } catch (error) {
          console.error("Error uploading image: ", error);
          status.innerText = "Error uploading image: " + error.message;
          status.style.color = "red";
        }
      }
    </script>
  </body>
</html>
